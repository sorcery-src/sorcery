@use "sass:list";
@use "sass:map";
@use "sass:string";

@use "../src/sass" as * with ($headless: true);

// TODO: Convert HSL back to RGB?

// Ex:
//
// has-suffix(16, px)   -> false
// has-suffix(16px, px) -> true
//
@function has-suffix($src, $cmp) {
	$str-src: "" + $src;
	$str-cmp: "" + $cmp;
	@return string.slice($str-src, 1 + string.length($str-src) - string.length($str-cmp)) == $str-cmp;
}

// Ex:
//
// $light: (
//   ui-app-color: color(black),
//   ui-app-bg: color(white),
// );
// $dark: (
//   ui-app-color: color(white),
//   ui-app-bg: color(black),
// );
// @include themes((
//   light: $light,
//   dark: $dark,
// ));
//
// -> :root {
// ->   --ui-app-color: hsl(0deg, 0%, 0%);
// ->   --ui-app-bg: hsl(0deg, 0%, 100%);
// ->   transition: var(--theme-transition);
// -> }
// -> [data-theme="dark"] {
// ->   --ui-app-color: hsl(0deg, 0%, 100%);
// ->   --ui-app-bg: hsl(0deg, 0%, 0%);
// -> }
// -> .ui-app {
// ->   color: var(--ui-app-color);
// ->   background-color: var(--ui-app-bg);
// ->   transition: var(--theme-transition);
// -> }
//
// TODO: Add support for `root-bg` and `border-color-default`?
// TODO: Add support for n-many themes; `[data-theme="..."]` should be dynamic.
//
// prettier-ignore
@mixin themes($light, $dark, $transition: true) {
	$theme-transition: var(--theme-transition);
	@if $transition == false {
		$theme-transition: null;
	}

	// TODO: Assert `$light-ast` and `$dark-ast` are mirrors.
	$light-ast: parse-ast($light);
	:root {
		@each $mk, $mv in $light-ast {
			@each $info in $mv {
				--#{map.get($info, var)}: #{map.get($info, value)};
			}
		}
		transition: $theme-transition;
	}

	$dark-ast: parse-ast($dark);
	[data-theme="dark"] {
		@each $mk, $mv in $dark-ast {
			@each $info in $mv {
				--#{map.get($info, var)}: #{map.get($info, value)};
			}
		}
	}

	@each $mk, $mv in $light-ast {
		.#{$mk} {
			@each $info in $mv {
				#{map.get($info, property)}: var(--#{map.get($info, var)});
			}
			transition: $theme-transition;
		}
	}
}

$-legend: (
	background-color: bg,
	border-color: border-color,
	box-shadow: shadow,
	color: color,
	fill: fill,
	opacity: opacity,
	stroke: stroke,
);

// Parses a lightweight abstract syntax tree.
@function parse-ast($map) {
	$ast: ();
	@each $mk, $mv in $map {
		@each $tk, $tv in $-legend {
			@if has-suffix($mk, $tv) {
				$n: string.index($mk, $tv);
				$key: string.slice($mk, 1, $n - 2);
				$current: map.get($ast, $key);

				// prettier-ignore
				$ast: map.set(
					$ast,
					$key,
					list.append(
						if(not $current, (), $current),
						(
							var: $mk,      // -> app
							property: $tk, // -> background-color
							value: $mv,    // -> hsl(...)
						)
					)
				);
			}
		}
	}
	@return $ast;
}

:root {
	--root-bg: hsl(var(--gray-50));
	--placeholder-bg-default: hsl(var(--gray-300));
	--border-color-default: hsl(var(--gray-200));
}
[data-theme="dark"] {
	--root-bg: #090c14;
	--placeholder-bg-default: hsl(var(--gray-700));
	--border-color-default: hsl(var(--gray-900));
}

:root {
	background-color: var(--root-bg);
	transition: var(--theme-transition);
}
[class*="border-"] {
	transition: var(--theme-transition);
}

// prettier-ignore
$light: (
	ft-app-bg: color(white),
	ft-app-shadow: (0 0 0 1px color(gray-200), var(--shadow-xs), var(--shadow-md)),
	ft-content-search-bar-bg: color(white),
	ft-content-card-bg: color(white),
	ft-sidebar-bg: color(white),
	ft-sidebar-preview-bg: color(white),
	ft-svg-color: color(black),
	ft-faded-svg-color: color(black, 0.5),
);

// prettier-ignore
$dark: (
	ft-app-bg: color(gray-800),
	ft-app-shadow: (0 0 0 1px color(gray-700), var(--shadow-xs), var(--shadow-md)),
	ft-content-search-bar-bg: color(gray-800),
	ft-content-card-bg: color(gray-800),
	ft-sidebar-bg: color(gray-800),
	ft-sidebar-preview-bg: color(gray-800),
	ft-svg-color: color(white),
	ft-faded-svg-color: color(white, 0.5),
);

@at-root {
	@include themes($light, $dark);
}
